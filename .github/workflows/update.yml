---
name: Update Packages

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  find-recipes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Checkout Submodules
        run: |
          mkdir -p ~/.ssh
          cat .github/known_hosts >> ~/.ssh/known_hosts
          git submodule update --init --recursive --remote

      - name: Find Updated Packages
        id: set-matrix
        run: |
          echo "matrix=$(./scripts/update.py --check --repo ./aur.archlinux.org)" >> $GITHUB_OUTPUT
          cat $GITHUB_OUTPUT

  build:
    permissions:
      packages: read
    needs: find-recipes
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/robertrosca/aur-pkgs:main
      options: --user root
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.github_token }}
    if: '${{ needs.find-recipes.outputs.matrix != ''{"include": []}'' }}'
    strategy:
      matrix: ${{ fromJson(needs.find-recipes.outputs.matrix) }}
    name: Update "${{ matrix.package }}"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Checkout Submodules
        run: |
          mkdir -p ~/.ssh
          cat .github/known_hosts >> ~/.ssh/known_hosts
          git config --global --add safe.directory $PWD
          git submodule update --init --recursive --remote ${{ matrix.package }}
          chown -R builder:builder ${{ matrix.package }}

      - name: Update
        run: |
          runuser -u builder -- ./scripts/update.py ${{ matrix.package }} > ${{ matrix.package }}/COMMIT_MSG

      - name: Check
        run: |
          cd ${{ matrix.package }}
          runuser -u builder -- PKGEXT='.pkg.tar' makepkg -s --check --noprogressbar --noconfirm --nocolor --clean

      - name: Commit and Push
        run: |
          cd ${{ matrix.package }}
          git config --global --add safe.directory $PWD
          git add PKGBUILD .SRCINFO
          git commit -m $(cat COMMIT_MSG)
          git push
